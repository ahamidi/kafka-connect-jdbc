#!/usr/bin/env bash

set -e

connector_name="$1"
app_url="$2"
kafka_addon_name=${KAFKA_ADDON:-KAFKA}
postgres_addon_name=${POSTGRES_ADDON:-DATABASE}
jdbc_env_var="JDBC_$(echo $postgres_addon_name)_URL"
jdbc_url=$(echo ${!jdbc_env_var})

[ -z $connector_name ] && {
  echo "connector name must be provided" >&2
  exit 1
}

[ -z $app_url ] && {
  echo "app url must be provided" >&2
  exit 1
}

[ -z $TABLE_WHITELIST ] && {
  echo "TABLE_WHITELIST is missing" >&2
  exit 1
}

[ -z $postgres_addon_name ] && {
  echo "$postgres_addon_name is missing" >&2
  exit 1
}

connect_username=${CONNECT_USERNAME:-connect}
connect_password=${CONNECT_PASSWORD}
[ -z $CONNECT_PASSWORD ] && {
  echo "CONNECT_PASSWORD is missing" >&2
  exit 1
}
cat > curl_netrc <<CURLNETRC
machine $app_url login $connect_username password $connect_password
CURLNETRC

curl --netrc-file ./curl_netrc -X POST https://$app_url/connectors -H "Content-Type: application/json" --data @- << EOF
{
  "name": "$connector_name",
  "config": {
    "connector.class": "io.confluent.connect.jdbc.JdbcSourceConnector",
    "tasks.max": "1",
    "connection.url":"$jdbc_url",
    "connection.attempts":"3",
    "connection.backoff.ms":"10000",
    "table.whitelist":"$TABLE_WHITELIST",
    "mode":"incrementing",
    "incrementing.column.name":"${INCREMENTING_COLUMN:-id}",
    "poll.interval.ms":"5000",
    "batch.max.rows":"100",
    "table.poll.interval.ms":"60000",
    "topic.prefix":"pg-",
    "table.types":"TABLE",
    "timestamp.delay.interval.ms":"0"
  }
}
EOF

